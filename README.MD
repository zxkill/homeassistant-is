# Интеграция Intersvyaz для Home Assistant

## Быстрый обзор
Интеграция **Intersvyaz Doorphone** позволяет подключить домофон от провайдера «Интерсвязь» к умному дому Home Assistant. Репозиторий содержит готовый каркас с авторизацией по SMS, хранением токенов и сервисом для удаленного открытия двери. Благодаря подробным комментариям и расширенному логированию разработчикам проще адаптировать решение под реальные API компании.

## Ключевые возможности
- Мастер настройки с двухфакторной авторизацией по номеру телефона и SMS-коду.
- Асинхронный клиент `IntersvyazApiClient` для отправки номера телефона, подтверждения кода, обновления refresh-токена и открытия домофона.
- Автоматическое сохранение и обновление JWT-токенов в конфигурации Home Assistant.
- Сервис `intersvyaz.open_door`, доступный из сценариев и автоматизаций Home Assistant.
- Набор тестов на `pytest` с эмуляцией облачного API для уверенности в корректной работе клиента.
- Динамическая подсказка о типе подтверждения (SMS или звонок) прямо в мастере настройки.
- Отображение текстов оператора и ошибок проверки кода для понятного сценария авторизации.

## Требования и подготовка
1. Убедитесь, что у вас установлен Home Assistant версии 2023.5 или новее.
2. Для установки через [HACS](https://hacs.xyz/) добавьте репозиторий как **Custom Repository** в категории *Integration* и установите доступную версию.
3. Для ручной установки скопируйте директорию `custom_components/intersvyaz` в каталог `config/custom_components` вашего инстанса Home Assistant.
4. Перезапустите Home Assistant, чтобы компонент был обнаружен системой.
5. Установите зависимости для разработки: `pip install -r requirements_dev.txt` (создайте файл под свои нужды) и `pip install pytest aiohttp` для запуска тестов.

## Настройка интеграции
1. В интерфейсе Home Assistant перейдите в «Настройки» → «Устройства и службы» → «Добавить интеграцию».
2. Найдите интеграцию **Intersvyaz Doorphone** и введите номер телефона, привязанный к домофону.
3. Дождитесь подсказки в мастере настройки: система сообщит, придёт ли SMS или поступит звонок, и следуйте инструкции.
4. Подтвердите код, отправленный оператором (введите последние цифры звонящего номера или SMS-код).
5. После успешной авторизации интеграция сохранит access- и refresh-токены и зарегистрирует сервис открытия двери.

## Разработка и тестирование
- Реальные URL и структуру запросов API замените в `custom_components/intersvyaz/const.py` и методах `IntersvyazApiClient`.
- Для локального тестирования выполните `pytest` в корне репозитория.
- Логирование на русском языке помогает быстро диагностировать ошибки и интегрировать реальные сценарии.
- При неуспешном вводе кода мастер настройки покажет ответ сервера (например, «Неверный код подтверждения»), что ускоряет отладку.
- Файл `hacs.json` обеспечивает совместимость репозитория с HACS и контролирует минимальную поддерживаемую версию Home Assistant.

## SEO ключевые слова
Home Assistant домофон Интерсвязь, интеграция Intersvyaz, открыть домофон через умный дом, SMS авторизация Интерсвязь, Home Assistant custom component, JWT refresh token Home Assistant.
