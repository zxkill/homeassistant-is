# Интеграция Intersvyaz для Home Assistant

Интеграция **Intersvyaz Doorphone** связывает домофоны провайдера «Интерсвязь» с экосистемой Home Assistant. Решение повторяет последовательность авторизации мобильного приложения: звонок на номер абонента, выбор договора, получение токенов двух различных API и управление домофоном напрямую из умного дома.

## Ключевые возможности
- Полный мастер настройки: подтверждение телефона, вывод текста оператора, выбор договора и ввод параметров домофона.
- Автоматическая генерация и повторное использование идентификатора устройства (`device_id`) для каждого умного дома.
- Получение токена мобильного API и токена CRM, хранение их в записи конфигурации и проверка срока действия.
- Сенсоры Home Assistant с балансом договора и данными профиля абонента.
- Автоматическое определение формата валюты баланса для любых версий Home Assistant.
- Комплект кнопок «Открыть домофон» с автоматическими названиями по адресу и сервис `intersvyaz.open_door` для автоматизаций.
- Автоматический поиск доступных домофонов: интеграция сама подтягивает MAC-адрес, номер реле, ссылку открытия и снимок камеры.
- Использование готовых ссылок открытия из API `/domofon/relays` без ручной сборки URL и подробное логирование команд.
- Камера домофона, которая обновляется каждые 5 секунд по ссылке из API и регулярно переполучает токен снимка.
- Автоматическое распознавание лиц на снимках домофона и мгновенное открытие двери для доверенных гостей.
- Подробное русскоязычное логирование и комментарии для удобной отладки.
- Тесты `pytest`, эмулирующие облачное API и покрывающие ключевую бизнес-логику.

## Установка
[![Open your Home Assistant instance and open a repository inside the Home Assistant Community Store.](https://my.home-assistant.io/badges/hacs_repository.svg)](https://my.home-assistant.io/redirect/hacs_repository/?owner=ZxKill&repository=https%3A%2F%2Fgithub.com%2Fzxkill%2Fhomeassistant-is)
1. Установите Home Assistant 2023.5+.
2. Через [HACS](https://hacs.xyz/) добавьте репозиторий как **Custom Repository** (категория *Integration*) либо вручную скопируйте `custom_components/intersvyaz` в каталог `config/custom_components`.
3. Перезапустите Home Assistant, затем добавьте интеграцию **Intersvyaz Doorphone** в разделе «Настройки → Устройства и службы».

## Настройка шага за шагом
1. Введите номер телефона, привязанный к услугам Интерсвязи.
2. Система сгенерирует уникальный `device_id`, отправит запрос `/mobile/auth/get-confirm` и отобразит текст оператора.
3. Введите код из звонка/СМС. После проверки (`/mobile/auth/check-confirm`) выберите договор из списка адресов.
4. Интеграция запросит токен `/mobile/auth/get-token`, сохранит идентификаторы договора и автоматически выполнит два запроса `/domofon/relays`:
   сначала для основных подъездов (`isShared=0`), затем для расшаренных (`isShared=1`).
   На основании объединённого ответа в конфигурацию добавятся MAC-адрес домофона, номер реле, идентификатор входа, ссылка для открытия и URL последнего снимка с камеры.
5. На завершающем шаге будет получен JWT `/api/auth-lk`, после чего создастся конфигурация с сохранёнными токенами и данными домофона.
   CRM API принимает только `buyerId=1`, поэтому интеграция автоматически подставляет это значение, параллельно фиксируя предупреждение в логах, если провайдер отдаёт другие идентификаторы.

## Доступные сущности
- `sensor.<имя>_balance` – баланс договора с атрибутами задолженности и статуса блокировки.
- `sensor.<имя>_profile` – сводка профиля абонента (логин, номер договора, услуги).
- `button.<имя>_door_open_*` – кнопки мгновенного открытия всех доступных домофонов с подписью адреса.
- `camera.<имя>_door_camera` – обновляемый снимок домофона с автоматическим продлением ссылки раз в несколько часов и привязкой к устройству интеграции.

Дополнительно регистрируется сервис `intersvyaz.open_door` с параметрами `entry_id` и опциональным `door_uid`, что позволяет запускать сценарии для конкретного подъезда как из автоматизаций, так и из панелей Home Assistant.

## Как отобразить камеру в интерфейсе Home Assistant
1. После успешного прохождения мастера настройки откройте раздел «Настройки → Устройства и службы → Intersvyaz Doorphone» и убедитесь, что появился девайс «Домофон Интерсвязь» с сущностями кнопок и камеры.
2. Перейдите на любую панель Lovelace, нажмите «Редактировать панель» и добавьте новую карту «Камера» или «Картинка».
3. В списке сущностей выберите `camera.<имя>_door_camera`. Кадр будет обновляться каждые пять секунд, а ссылка автоматически переполучается согласно расписанию интеграции, поэтому ручных действий не требуется.
4. При необходимости включите запись или потоковую передачу средствами Home Assistant – интеграция предоставляет URL кадра, совместимый со стандартными функциями платформы.

## Автоматическое открытие по распознаванию лиц
1. Установите системный пакет [`face_recognition`](https://github.com/ageitgey/face_recognition) на тот же сервер, где работает Home Assistant (для Home Assistant OS – через [Community SSH Add-on](https://github.com/home-assistant/addons/blob/master/ssh/DOCS.md), для контейнера – внутри образа). Без этой зависимости распознавание будет отключено, в логах появится предупреждение.
2. Добавьте в конфигурацию минимум одну камеру домофона, чтобы Home Assistant регулярно получал снимки (интеграция делает это автоматически для подъездов с параметром `HAS_VIDEO=1`).
3. Откройте «Настройки → Устройства и службы → Intersvyaz Doorphone → Настройки» и используйте встроенное меню:
   - Нажмите кнопку «Добавить лицо», введите понятное имя гостя и загрузите фотографию в формате JPG/PNG. Файл сразу сохраняется в настройках, а в журнале появится запись о добавлении.
   - Для удаления используйте пункт «Удалить лицо» – список формируется автоматически из уже сохранённых гостей.
   - В подсказке формы отображается полный перечень зарегистрированных лиц, поэтому легко контролировать состав базы без переключения между окнами.
4. При необходимости используйте автоматизации: сервис `intersvyaz.add_known_face` поддерживает передачу `image_url` или `image_base64`, что удобно для программного пополнения базы; удаление доступно через `intersvyaz.remove_known_face`.
5. Как только камера получит кадр с известным лицом, интеграция проверит расстояние признаков (порог по умолчанию 0.6) и при совпадении вызовет кнопку открытия домофона. Повторные открытия для одного подъезда блокируются на 30 секунд, чтобы избежать циклического открытия при движении в кадре.
6. Создавайте автоматизации на основе `persistent_notification` или логов, если требуется отправлять сообщения о распознавании (например, по webhook или в Telegram).

## Разработка и тестирование
- Код снабжён комментариями и логами на русском языке, описывающими каждый сетевой запрос и ключевые переходы, включая повторные запросы `/domofон/relays` для обновления токенов снимков.
- В логах дополнительно выводится безопасный контекст HTTP-запросов (метод, URL, ключевые заголовки) с маскированием токенов и паролей для быстрой диагностики 401/403 ошибок.
- Конфигурация хранит `device_id`, токены и даты доступа, что облегчает повторное использование и диагностику.
- Для локальных проверок выполните `pytest` в корне репозитория.
- Автотест `tests/test_init.py` гарантирует корректную регистрацию сервиса `intersvyaz.open_door`, проверяет генерацию кнопок для основного и расшаренных подъездов и контролирует сохранность токенов при каждом открытии.

## SEO ключевые фразы
Home Assistant домофон Интерсвязь, интеграция Intersvyaz, открыть домофон через Home Assistant, SMS авторизация Интерсвязь, CRM токен Интерсвязь, Intersvyaz doorphone Home Assistant, камера домофона Home Assistant, снимок домофона Intersvyaz, распознавание лиц домофон Home Assistant.
