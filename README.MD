# Интеграция Intersvyaz для Home Assistant

Интеграция **Intersvyaz Doorphone** связывает домофоны провайдера «Интерсвязь» с экосистемой Home Assistant. Решение повторяет последовательность авторизации мобильного приложения: звонок на номер абонента, выбор договора, получение токенов двух различных API и управление домофоном напрямую из умного дома.

## Ключевые возможности
- Полный мастер настройки: подтверждение телефона, вывод текста оператора, выбор договора и ввод параметров домофона.
- Автоматическая генерация и повторное использование идентификатора устройства (`device_id`) для каждого умного дома.
- Получение токена мобильного API и токена CRM, хранение их в записи конфигурации и проверка срока действия.
- Сенсоры Home Assistant с балансом договора и данными профиля абонента.
- Кнопка «Открыть домофон» и сервис `intersvyaz.open_door` для автоматизаций и сценариев.
- Автоматический поиск доступных домофонов: интеграция сама подтягивает MAC-адрес, номер реле, ссылку открытия и снимок камеры.
- Подробное русскоязычное логирование и комментарии для удобной отладки.
- Тесты `pytest`, эмулирующие облачное API и покрывающие ключевую бизнес-логику.

## Установка
[![Open your Home Assistant instance and open a repository inside the Home Assistant Community Store.](https://my.home-assistant.io/badges/hacs_repository.svg)](https://my.home-assistant.io/redirect/hacs_repository/?owner=ZxKill&repository=https%3A%2F%2Fgithub.com%2Fzxkill%2Fhomeassistant-is)
1. Установите Home Assistant 2023.5+.
2. Через [HACS](https://hacs.xyz/) добавьте репозиторий как **Custom Repository** (категория *Integration*) либо вручную скопируйте `custom_components/intersvyaz` в каталог `config/custom_components`.
3. Перезапустите Home Assistant, затем добавьте интеграцию **Intersvyaz Doorphone** в разделе «Настройки → Устройства и службы».

## Настройка шага за шагом
1. Введите номер телефона, привязанный к услугам Интерсвязи.
2. Система сгенерирует уникальный `device_id`, отправит запрос `/mobile/auth/get-confirm` и отобразит текст оператора.
3. Введите код из звонка/СМС. После проверки (`/mobile/auth/check-confirm`) выберите договор из списка адресов.
4. Интеграция запросит токен `/mobile/auth/get-token`, сохранит идентификаторы договора и автоматически выполнит запрос `/domofon/relays`.
   На основании ответа в конфигурацию добавятся MAC-адрес домофона, номер реле, идентификатор входа, ссылка для открытия и URL последнего снимка с камеры.
5. На завершающем шаге будет получен JWT `/api/auth-lk`, после чего создастся конфигурация с сохранёнными токенами и данными домофона.
   CRM API принимает только `buyerId=1`, поэтому интеграция автоматически подставляет это значение, параллельно фиксируя предупреждение в логах, если провайдер отдаёт другие идентификаторы.

## Доступные сущности
- `sensor.<имя>_balance` – баланс договора с атрибутами задолженности и статуса блокировки.
- `sensor.<имя>_profile` – сводка профиля абонента (логин, номер договора, услуги).
- `button.<имя>_door_open` – кнопка мгновенного открытия домофона.

Дополнительно регистрируется сервис `intersvyaz.open_door` с параметром `entry_id`, что позволяет запускать сценарии из автоматизаций или сценариев Home Assistant.

## Разработка и тестирование
- Код снабжён комментариями и логами на русском языке, описывающими каждый сетевой запрос и ключевые переходы.
- В логах дополнительно выводится безопасный контекст HTTP-запросов (метод, URL, ключевые заголовки) с маскированием токенов и паролей для быстрой диагностики 401/403 ошибок.
- Конфигурация хранит `device_id`, токены и даты доступа, что облегчает повторное использование и диагностику.
- Для локальных проверок выполните `pytest` в корне репозитория.

## SEO ключевые фразы
Home Assistant домофон Интерсвязь, интеграция Intersvyaz, открыть домофон через Home Assistant, SMS авторизация Интерсвязь, CRM токен Интерсвязь, Intersvyaz doorphone Home Assistant.
